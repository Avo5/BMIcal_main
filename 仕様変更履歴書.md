# 仕様変更履歴書

このファイルは `Plan.md` に記載された初期仕様から、本リポジトリで行われた主要な仕様変更を時系列でまとめたものです。

---

## 変更履歴（要約）

### 2025-11-30 — プロフィール: `height_cm` を users テーブルに追加
- 理由: 体重記録時に毎回身長を入力させるのは冗長なため、プロフィールに身長を持たせ、記録フォームで未入力時はプロフィールの身長をフォールバックするように実装。
- 影響: `users.height_cm` カラム追加、`settings_profile.php` のフォームと保存処理、`record` 作成・編集処理のフォールバック実装。

### 2025-12-01 — 活動レベル (`activity_level`) の追加
- 目的: TDEE を計算する際にユーザーの活動量を考慮するため。
- 実装: `users.activity_level` を ENUM('low','medium','high') として追加。`lib/functions.php` に `activity_factor_from_level()` を実装し、'low'→1.2, 'medium'→1.55, 'high'→1.725 を返す。
- ポリシー: activity_level が未設定の場合はデフォルトで low (1.2) を使う挙動に変更（ユーザー負担を減らすため）。

### 2025-12-01 — 目標自動計算（目標体重 → BMI/BMR/TDEE）
- 仕様: ユーザーが目標体重を入力すると、プロフィールに身長・生年月日・性別が揃っている場合に限り、サーバ側で目標 BMI/BMR/TDEE を自動計算して保存するようにした。
- 影響: `settings_goal.php` の保存処理で自動算出ロジックを追加。

### 2025-12-02 — 目標編集 UX の変更（4つのうち1つのみ編集可）
- 理由: 4つの目標値（理想体重、目標 BMI、目標 BMR、目標 TDEE）が相互に依存しており、ユーザーが矛盾した数値を入力しないようにするため。
- 実装: `settings_goal.php` にラジオボタンで「どれを直接編集するか」を選択する UI を追加。選択された項目をもとに、残りの項目を自動計算して保存する（サーバ側ロジックあり）。
- 例: ユーザーが「目標 BMR を編集」した場合、BMR →（逆算）→ 目標体重 → BMI/TDEE の順に算出。

### 2025-12-03 — ダッシュボード: Chart.js を用いた推移グラフと期間フィルタ
- 内容: 体重・BMI の折れ線グラフを Chart.js で表示。期間選択（30日/90日/1年/全て）で表示データを切り替え可能。
- 追加: 目標体重が設定されている場合はグラフに「差（体重 - 目標）」系列を追加。

### 2025-12-03 — CSV エクスポート機能を追加
- 実装: `public/export_records_csv.php` を追加し、ユーザーの記録を CSV でダウンロード可能にした。

### 2025-12-04 — バッジ機能の廃止
- 経緯: 一時的に「目標達成バッジ」を追加したが、UI 方針の変更によりバッジ表示を廃止することに決定された。
- 実装: ダッシュボードのバッジ判定ロジック・表示、関連 CSS を削除。

---

## 参考: 実装上の注意点
- `schema.sql` をベースに追加カラムを ALTER するためのスクリプト `scripts/generate_alter_from_schema.php` と、出力例 `migrations/alter_add_columns.sql` を用意してあります。実行前に必ずバックアップを取ってください。
- 自動計算ロジックに利用する値（身長、生年月日、性別）が未設定の場合は自動計算をスキップして `NULL` を保存する仕様です。

## 今後の検討項目（未実装 / 推奨）
- 目標達成判定の閾値やアルゴリズムの細分化（±0.5kg は暫定値）。
- 目標履歴の追跡（達成／未達成のログを保持し、日付ごとに可視化する）。
- CSV にもっとメタ情報（ユーザー名、エクスポート日時など）を付与するオプション。
- ユーザーごとのデフォルト activity_level ポリシー変更（UI で既定値を指定可能にする）。

---

（この履歴は変更の要点をコンパクトにまとめたものです。詳細な実装差分は Git のコミット履歴と `Plan.md` を参照してください。）
